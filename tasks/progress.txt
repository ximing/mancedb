## Codebase Patterns
- Use `experimentalDecorators: true` in tsconfig for @rabjs/react decorators to work
- Service class from @rabjs/react is already observable - no need for @Action decorator on methods
- All Service methods are automatically actions (batch updates) unless marked with @SyncAction
- Keep auth.service.ts and theme.service.ts as they are needed for the auth flow

## 2026-02-15 - Initial Setup
- Created branch `ralph/lancedb-admin`
- Starting US-001: Clean up existing code

## 2026-02-15 - US-001 Complete
- Deleted backend controllers: memo.controller.ts, category.controller.ts, attachment.controller.ts, backup.controller.ts
- Deleted backend services: memo.service.ts, category.service.ts, attachment.service.ts, backup.service.ts, backup-executor.ts, backup-worker.ts, memo-relation.service.ts, embedding.service.ts, multimodal-embedding.service.ts, scheduler.service.ts
- Deleted frontend pages: home, gallery, ai-explore, settings
- Deleted DTOs: memo.ts, category.ts, attachment.ts
- Deleted API files: memo.ts, attachment.ts, export.ts
- Deleted unified-storage-adapter folder
- Updated schema.ts to only keep users and table_migrations
- Updated migrations to only create users table
- Updated lancedb.ts to remove references to deleted tables
- Updated config.ts to remove backup and attachment config
- Updated app.ts to remove backup and scheduler initialization
- Updated controllers/index.ts to only export auth and user controllers
- Updated DTO index.ts to only export auth, user, response
- Simplified App.tsx to placeholder landing page
- Updated auth page text to reflect new project name
- Recreated auth.service.ts and theme.service.ts with proper @rabjs/react patterns
- Fixed tsconfig.app.json to enable experimentalDecorators
- Fixed login-form.tsx and register-form.tsx to match new service API
- Fixed layout.tsx to use isDark as property not method
- Build passes for both server and web

**Files changed:**
- apps/server/src/controllers/index.ts
- apps/server/src/controllers/v1/memo.controller.ts (deleted)
- apps/server/src/controllers/v1/category.controller.ts (deleted)
- apps/server/src/controllers/v1/attachment.controller.ts (deleted)
- apps/server/src/controllers/v1/backup.controller.ts (deleted)
- apps/server/src/services/*.service.ts (multiple deleted)
- apps/server/src/sources/lancedb.ts
- apps/server/src/sources/unified-storage-adapter/ (deleted)
- apps/server/src/models/db/schema.ts
- apps/server/src/migrations/scripts/001-init.ts
- apps/server/src/migrations/scripts/002-create-indexes.ts
- apps/server/src/migrations/scripts/index.ts
- apps/server/src/config/config.ts
- apps/server/src/app.ts
- apps/web/src/App.tsx
- apps/web/src/main.tsx
- apps/web/src/pages/ (multiple deleted)
- apps/web/src/components/attachment-uploader.tsx (deleted)
- apps/web/src/components/memo-editor-form.tsx (deleted)
- apps/web/src/components/layout.tsx
- apps/web/src/pages/auth/auth.tsx
- apps/web/src/pages/auth/components/login-form.tsx
- apps/web/src/pages/auth/components/register-form.tsx
- apps/web/src/services/auth.service.ts (recreated)
- apps/web/src/services/theme.service.ts (recreated)
- apps/web/src/api/*.ts (multiple deleted)
- apps/web/tsconfig.app.json
- packages/dto/src/index.ts
- packages/dto/src/memo.ts (deleted)
- packages/dto/src/category.ts (deleted)
- packages/dto/src/attachment.ts (deleted)

**Learnings for future iterations:**
- The @rabjs/react framework uses experimental decorators - must enable in tsconfig
- Service class from rabjs is already observable, methods are automatically actions
- When deleting files, be careful not to delete services that are still needed (auth, theme)
- The project uses pnpm workspaces with turbo for build orchestration
- Server build outputs to dist/, web build outputs to server/public/
---

## 2026-02-15 - US-002 Complete
- Created connections table schema with all required fields including encrypted S3 credentials
- Created query_history table schema for tracking SQL execution history
- Added ConnectionRecord and QueryHistoryRecord TypeScript interfaces
- Created migration script 003-admin-tables.ts following existing migration pattern
- Registered both migrations in the index.ts
- Both server and web typecheck pass

**Files changed:**
- apps/server/src/models/db/schema.ts
- apps/server/src/migrations/scripts/003-admin-tables.ts (new)
- apps/server/src/migrations/scripts/index.ts

**Learnings for future iterations:**
- LanceDB uses Apache Arrow schemas - use Utf8, Int32, Timestamp types from apache-arrow package
- Timestamp fields use TimeUnit.MILLISECOND for millisecond precision
- Migration version numbers must be unique per table
- Use createEmptyTable to create tables with explicit schemas
- All nullable fields should have `true` as the third parameter in Field constructor
---

## 2026-02-15 - US-003 Complete
- Implemented ConnectionService with full CRUD operations
- Created AES-256-GCM encryption for S3 credentials using crypto module
- Created bcrypt password hashing for database authentication
- Created ConnectionV1Controller with all required REST endpoints:
  - POST /api/v1/connections - Create connection with validation
  - GET /api/v1/connections - List all connections (no sensitive fields)
  - GET /api/v1/connections/:id - Get single connection details
  - PUT /api/v1/connections/:id - Update connection
  - DELETE /api/v1/connections/:id - Delete connection using LanceDB delete
  - POST /api/v1/connections/:id/test - Test connection to LanceDB
- All endpoints return unified response format via ResponseUtil
- Sensitive fields (s3AccessKey, s3SecretKey, dbPasswordHash) are encrypted and never returned in public APIs
- Server and web builds pass typecheck

**Files changed:**
- apps/server/src/services/connection.service.ts (new)
- apps/server/src/controllers/v1/connection.controller.ts (new)
- apps/server/src/controllers/index.ts

**Learnings for future iterations:**
- LanceDB Table has a `delete(whereClause)` method for removing records
- Use `scryptSync` to derive encryption key from JWT secret for AES encryption
- Store IV and authTag alongside encrypted data for AES-GCM decryption
- bcrypt is already available in the project for password hashing
- Always escape single quotes in LanceDB where clauses to prevent injection issues
- Use `table.update()` for partial updates and `table.delete()` for deletions
---

## 2026-02-16 - US-004 Complete
- Implemented ConnectionAuthService with authenticate, refreshToken, and verifyToken methods
- Added POST /api/v1/auth/connections/login endpoint for connection-based authentication
- Added POST /api/v1/auth/connections/refresh endpoint for token refresh
- Created ConnectionLoginDto and RefreshTokenDto in the DTO package
- JWT tokens include connectionId, username, and type with 24-hour expiration
- Password verification uses bcrypt compare from ConnectionService
- Returns 401 with friendly error messages on authentication failure
- Sets httpOnly cookie with the token for security

**Files changed:**
- packages/dto/src/auth.ts
- apps/server/src/services/connection-auth.service.ts (new)
- apps/server/src/services/connection.service.ts
- apps/server/src/controllers/v1/auth.controller.ts

**Learnings for future iterations:**
- Connection-based auth uses separate endpoints: /api/v1/auth/connections/login and /refresh
- JWT payload includes connectionId, username, and type for easy access in subsequent requests
- The verifyToken method returns null on failure - useful for middleware authentication
- Cookie is set with httpOnly, secure in production, and 24-hour maxAge
- ConnectionService.verifyPassword is reused for password checking
---

## 2026-02-16 - US-005 Complete
- Created Connection DTO types (ConnectionDto, CreateConnectionDto, UpdateConnectionDto, TestConnectionResponseDto)
- Created Connection API functions for all CRUD operations and connection testing
- Created ConnectionService using @rabjs/react Service class for state management
- Implemented ConnectionListPage component with:
  - Grid layout showing connection cards with name, type, path, last connected time
  - Search/filter functionality by name, type, path, or bucket
  - Delete connection with confirmation modal
  - Empty state with CTA to create first connection
  - Loading states and error handling
- Added placeholder routes for /connections/new and /connections/:id/login
- All builds pass (typecheck and lint)

**Files changed:**
- packages/dto/src/connection.ts (new)
- packages/dto/src/index.ts
- apps/web/src/api/connection.ts (new)
- apps/web/src/services/connection.service.ts (new)
- apps/web/src/pages/connections/connection-list.tsx (new)
- apps/web/src/App.tsx

**Learnings for future iterations:**
- Use @rabjs/react's `view()` HOC for reactive components and `useService()` to access services
- Service class from @rabjs/react automatically makes all methods actions (batch updates)
- Connection cards show different icons/colors for Local (blue) vs S3 (purple) types
- The delete button appears on hover using Tailwind's `group-hover:opacity-100`
- Use `connection-list.tsx` as the main entry point for connection management
---

## 2026-02-16 - US-006 Complete
- Created ConnectionFormPage component with full create/edit functionality
- Implemented type selector with visual cards for Local (blue) and S3 (purple) types
- Added form sections: Connection Type, Basic Information, Authentication
- Local type form: name, localPath, username, password
- S3 type form: name, bucket, region, endpoint, accessKey, secretKey, username, password
- Added form validation for required fields with error messages
- Implemented test connection button with success/error result display
- Edit mode loads existing connection data and supports partial updates
- Password fields show/hide toggle for better UX
- Form submission creates/updates connection and navigates back to list
- All builds pass (typecheck and lint)

**Files changed:**
- apps/web/src/pages/connections/connection-form.tsx (new)
- apps/web/src/App.tsx
- apps/web/src/services/auth.service.ts (fixed lint errors)

**Learnings for future iterations:**
- The form uses controlled inputs with React state for all fields
- Type selector uses visual cards with different colors (blue for Local, purple for S3)
- Form validation clears errors when fields are updated
- Test connection creates a temporary connection then cleans up on failure
- Edit mode requires special handling - password/S3 keys are optional (leave blank to keep existing)
- Use `Record<string, unknown>` instead of `any` for API response typing to avoid lint errors
---

## 2026-02-16 - US-007 Complete
- Created ConnectionLoginPage component with connection info display
- Implemented login form with username and password fields
- Added password show/hide toggle button for better UX
- Login failure displays friendly error messages
- Login success saves JWT to localStorage and navigates to database interface
- Added "Back to Connections" link in header
- Created ConnectionAuthService for managing connection-based authentication state
- Created connection-auth.ts API file for login and token refresh
- Added getConnectionById method to ConnectionService for loading connection details
- Updated App.tsx to use ConnectionLoginPage component for /connections/:id/login route
- All builds pass (typecheck and lint)

**Files changed:**
- apps/web/src/pages/connection-login/connection-login.tsx (new)
- apps/web/src/services/connection-auth.service.ts (new)
- apps/web/src/api/connection-auth.ts (new)
- apps/web/src/App.tsx
- apps/web/src/services/connection.service.ts
- apps/web/src/services/auth.service.ts

**Learnings for future iterations:**
- Connection-based auth stores JWT in localStorage with key `mancedb_connection_auth`
- The ConnectionAuthService manages isAuthenticated state and current connection info
- Login page uses useParams to get connection ID from URL
- After successful login, user is redirected to `/connections/:id/database` (placeholder for now)
- Use `useService(ConnectionService)` to access service methods in components
- Password visibility toggle uses React state and conditional rendering
---

## 2026-02-16 - US-008 Complete
- Implemented DatabaseService with methods to connect to user's LanceDB database
- Created getTables() method to list all tables with row counts
- Created getDatabaseInfo() method to return database statistics
- Implemented DatabaseV1Controller with endpoints:
  - GET /api/v1/database/tables - Returns all tables with name, rowCount, sizeBytes
  - GET /api/v1/database/info - Returns database info including all tables
- Updated auth-handler.ts to support connection-based JWT authentication
- Added ConnectionAuthInfo type to express.ts for proper TypeScript typing
- Both endpoints require JWT authentication via @Authorized() decorator
- Database connections are properly closed after each operation

**Files changed:**
- apps/server/src/services/database.service.ts (new)
- apps/server/src/controllers/v1/database.controller.ts (new)
- apps/server/src/controllers/index.ts
- apps/server/src/middlewares/auth-handler.ts
- apps/server/src/types/express.ts

**Learnings for future iterations:**
- The auth-handler now supports both user tokens (mancedb_token) and connection tokens (mancedb_connection_token)
- Connection tokens are verified first using ConnectionAuthService.verifyToken()
- Use `ConnectionAuthInfo` type when accessing req.user in connection-authenticated routes
- LanceDB connections should be closed after use to avoid resource leaks
- The `db.tableNames()` method returns all table names in the database
- The `table.countRows()` method returns the number of rows in a table
---
