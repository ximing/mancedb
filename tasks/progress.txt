## Codebase Patterns
- Use `experimentalDecorators: true` in tsconfig for @rabjs/react decorators to work
- Service class from @rabjs/react is already observable - no need for @Action decorator on methods
- All Service methods are automatically actions (batch updates) unless marked with @SyncAction
- Keep auth.service.ts and theme.service.ts as they are needed for the auth flow

## 2026-02-15 - Initial Setup
- Created branch `ralph/lancedb-admin`
- Starting US-001: Clean up existing code

## 2026-02-15 - US-001 Complete
- Deleted backend controllers: memo.controller.ts, category.controller.ts, attachment.controller.ts, backup.controller.ts
- Deleted backend services: memo.service.ts, category.service.ts, attachment.service.ts, backup.service.ts, backup-executor.ts, backup-worker.ts, memo-relation.service.ts, embedding.service.ts, multimodal-embedding.service.ts, scheduler.service.ts
- Deleted frontend pages: home, gallery, ai-explore, settings
- Deleted DTOs: memo.ts, category.ts, attachment.ts
- Deleted API files: memo.ts, attachment.ts, export.ts
- Deleted unified-storage-adapter folder
- Updated schema.ts to only keep users and table_migrations
- Updated migrations to only create users table
- Updated lancedb.ts to remove references to deleted tables
- Updated config.ts to remove backup and attachment config
- Updated app.ts to remove backup and scheduler initialization
- Updated controllers/index.ts to only export auth and user controllers
- Updated DTO index.ts to only export auth, user, response
- Simplified App.tsx to placeholder landing page
- Updated auth page text to reflect new project name
- Recreated auth.service.ts and theme.service.ts with proper @rabjs/react patterns
- Fixed tsconfig.app.json to enable experimentalDecorators
- Fixed login-form.tsx and register-form.tsx to match new service API
- Fixed layout.tsx to use isDark as property not method
- Build passes for both server and web

**Files changed:**
- apps/server/src/controllers/index.ts
- apps/server/src/controllers/v1/memo.controller.ts (deleted)
- apps/server/src/controllers/v1/category.controller.ts (deleted)
- apps/server/src/controllers/v1/attachment.controller.ts (deleted)
- apps/server/src/controllers/v1/backup.controller.ts (deleted)
- apps/server/src/services/*.service.ts (multiple deleted)
- apps/server/src/sources/lancedb.ts
- apps/server/src/sources/unified-storage-adapter/ (deleted)
- apps/server/src/models/db/schema.ts
- apps/server/src/migrations/scripts/001-init.ts
- apps/server/src/migrations/scripts/002-create-indexes.ts
- apps/server/src/migrations/scripts/index.ts
- apps/server/src/config/config.ts
- apps/server/src/app.ts
- apps/web/src/App.tsx
- apps/web/src/main.tsx
- apps/web/src/pages/ (multiple deleted)
- apps/web/src/components/attachment-uploader.tsx (deleted)
- apps/web/src/components/memo-editor-form.tsx (deleted)
- apps/web/src/components/layout.tsx
- apps/web/src/pages/auth/auth.tsx
- apps/web/src/pages/auth/components/login-form.tsx
- apps/web/src/pages/auth/components/register-form.tsx
- apps/web/src/services/auth.service.ts (recreated)
- apps/web/src/services/theme.service.ts (recreated)
- apps/web/src/api/*.ts (multiple deleted)
- apps/web/tsconfig.app.json
- packages/dto/src/index.ts
- packages/dto/src/memo.ts (deleted)
- packages/dto/src/category.ts (deleted)
- packages/dto/src/attachment.ts (deleted)

**Learnings for future iterations:**
- The @rabjs/react framework uses experimental decorators - must enable in tsconfig
- Service class from rabjs is already observable, methods are automatically actions
- When deleting files, be careful not to delete services that are still needed (auth, theme)
- The project uses pnpm workspaces with turbo for build orchestration
- Server build outputs to dist/, web build outputs to server/public/
---

## 2026-02-15 - US-002 Complete
- Created connections table schema with all required fields including encrypted S3 credentials
- Created query_history table schema for tracking SQL execution history
- Added ConnectionRecord and QueryHistoryRecord TypeScript interfaces
- Created migration script 003-admin-tables.ts following existing migration pattern
- Registered both migrations in the index.ts
- Both server and web typecheck pass

**Files changed:**
- apps/server/src/models/db/schema.ts
- apps/server/src/migrations/scripts/003-admin-tables.ts (new)
- apps/server/src/migrations/scripts/index.ts

**Learnings for future iterations:**
- LanceDB uses Apache Arrow schemas - use Utf8, Int32, Timestamp types from apache-arrow package
- Timestamp fields use TimeUnit.MILLISECOND for millisecond precision
- Migration version numbers must be unique per table
- Use createEmptyTable to create tables with explicit schemas
- All nullable fields should have `true` as the third parameter in Field constructor
---

## 2026-02-15 - US-003 Complete
- Implemented ConnectionService with full CRUD operations
- Created AES-256-GCM encryption for S3 credentials using crypto module
- Created bcrypt password hashing for database authentication
- Created ConnectionV1Controller with all required REST endpoints:
  - POST /api/v1/connections - Create connection with validation
  - GET /api/v1/connections - List all connections (no sensitive fields)
  - GET /api/v1/connections/:id - Get single connection details
  - PUT /api/v1/connections/:id - Update connection
  - DELETE /api/v1/connections/:id - Delete connection using LanceDB delete
  - POST /api/v1/connections/:id/test - Test connection to LanceDB
- All endpoints return unified response format via ResponseUtil
- Sensitive fields (s3AccessKey, s3SecretKey, dbPasswordHash) are encrypted and never returned in public APIs
- Server and web builds pass typecheck

**Files changed:**
- apps/server/src/services/connection.service.ts (new)
- apps/server/src/controllers/v1/connection.controller.ts (new)
- apps/server/src/controllers/index.ts

**Learnings for future iterations:**
- LanceDB Table has a `delete(whereClause)` method for removing records
- Use `scryptSync` to derive encryption key from JWT secret for AES encryption
- Store IV and authTag alongside encrypted data for AES-GCM decryption
- bcrypt is already available in the project for password hashing
- Always escape single quotes in LanceDB where clauses to prevent injection issues
- Use `table.update()` for partial updates and `table.delete()` for deletions
---

## 2026-02-16 - US-004 Complete
- Implemented ConnectionAuthService with authenticate, refreshToken, and verifyToken methods
- Added POST /api/v1/auth/connections/login endpoint for connection-based authentication
- Added POST /api/v1/auth/connections/refresh endpoint for token refresh
- Created ConnectionLoginDto and RefreshTokenDto in the DTO package
- JWT tokens include connectionId, username, and type with 24-hour expiration
- Password verification uses bcrypt compare from ConnectionService
- Returns 401 with friendly error messages on authentication failure
- Sets httpOnly cookie with the token for security

**Files changed:**
- packages/dto/src/auth.ts
- apps/server/src/services/connection-auth.service.ts (new)
- apps/server/src/services/connection.service.ts
- apps/server/src/controllers/v1/auth.controller.ts

**Learnings for future iterations:**
- Connection-based auth uses separate endpoints: /api/v1/auth/connections/login and /refresh
- JWT payload includes connectionId, username, and type for easy access in subsequent requests
- The verifyToken method returns null on failure - useful for middleware authentication
- Cookie is set with httpOnly, secure in production, and 24-hour maxAge
- ConnectionService.verifyPassword is reused for password checking
---
