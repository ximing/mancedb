## Codebase Patterns
- Electron 项目使用 vite-plugin-electron 实现热重载开发
- TypeScript 配置使用 project references 分别配置 main/preload/renderer 进程
- 类型定义放在 src/types/ 目录，通过 import 在需要的地方引入
- IPC 通信使用 contextBridge 暴露 API，避免直接暴露 ipcRenderer
- LanceDB Node.js SDK (vectordb) 使用 `connect()` 连接数据库，`table.search([])` 查询数据
- IPC Router 模式：main 进程注册 `api:request` handler，将 HTTP-like 请求路由到本地服务方法
- LanceDB 限制：不支持添加/删除列、不支持表重命名（需复制数据实现）

---

# Ralph Progress Log
# Project: Electron Desktop Client for LanceDB Admin
# Branch: feat/electron-client
# Base Branch: main
# Started: 2026-02-16

## User Stories

[x] US-001: 创建 Electron 基础项目结构
[x] US-002: 集成 Web 应用到 Electron
[x] US-003: 实现 Web 项目 Electron 适配改造
[x] US-004: 实现本地文件系统访问
[x] US-005: 实现原生 LanceDB 连接模式
[ ] US-006: 实现连接模式切换 UI
[ ] US-007: 添加系统集成特性
[ ] US-008: 实现自动更新检查
[ ] US-009: 配置跨平台打包

## 2026-02-16 07:45 - US-001
- 创建 apps/client 目录，包含完整的 Electron 项目结构
- 配置 TypeScript：使用 project references 分别配置 main/preload/renderer
- 配置 Vite：使用 vite-plugin-electron 实现热重载
- 配置 ESLint：继承项目现有配置风格
- 添加开发脚本：pnpm dev 支持 hot reload
- 类型检查通过，lint 通过

**Learnings for future iterations:**
- vite-plugin-electron 自动处理 main/preload 进程的构建和热重载
- contextBridge 是安全的 IPC 通信方式，需要在 preload 中定义类型并在 renderer 中引入
- Electron 的 types 需要单独配置，不能和 DOM types 混用（main 进程）
- 项目使用 pnpm workspace，新包需要运行 pnpm install 安装依赖
---

## 2026-02-16 08:30 - US-002
- 更新 web app vite.config.ts：支持 ELECTRON=true 环境变量，构建输出到 apps/client/dist/web
- 更新 Electron main 进程：开发模式加载 web dev server (localhost:5173)，生产模式加载构建产物
- 更新 client vite.config.ts：配置 VITE_DEV_SERVER_URL 传递给 main 进程
- 添加环境检测工具：apps/web/src/utils/environment.ts (isElectron, isBrowser, getPlatform 等)
- 路由适配：App.tsx 根据环境自动选择 HashRouter (Electron) 或 BrowserRouter (浏览器)
- 添加类型定义：apps/web/src/types/electron.d.ts 声明 window.electronAPI
- 添加构建脚本：client package.json 添加 build:web 和 build:electron 脚本
- 根 package.json 添加 dev:client 和 build:client 脚本
- 类型检查通过，lint 通过

**Learnings for future iterations:**
- Electron 使用 file:// 协议加载本地文件时，需要使用 HashRouter 替代 BrowserRouter（History API 不支持 file 协议）
- vite-plugin-electron 通过 process.env.VITE_DEV_SERVER_URL 向 main 进程传递 dev server URL
- 使用 ELECTRON=true 环境变量控制 web app 的构建输出路径
- 环境检测通过多种方式：process.versions.electron, window.electronAPI, navigator.userAgent
- 开发流程：先启动 web dev server (localhost:5173)，然后启动 Electron 加载该 URL
---

## 2026-02-16 16:00 - US-003
- 创建统一 API 客户端：apps/web/src/utils/api-client.ts，支持 HTTP 和 IPC 两种模式
- 创建 IPC 请求工具：apps/web/src/utils/ipc-request.ts，用于 Electron 本地模式
- 更新 Electron preload 脚本：添加 invoke 方法支持 request-response 模式
- 更新 Electron 类型定义：添加 invoke 方法到 ElectronAPI 接口
- 迁移所有 API 文件：auth.ts, user.ts, connection.ts, connection-auth.ts, database.ts, table.ts, table-schema.ts, table-data.ts, query.ts
- 修复 environment.ts 类型问题：添加 Process 类型声明避免 TypeScript 错误
- 修复 tsconfig.renderer.json：调整 rootDir 以包含 types 目录
- 类型检查通过，lint 通过

**Learnings for future iterations:**
- 统一 API 客户端设计：api-client.ts 自动检测环境并选择 HTTP 或 IPC 模式
- IPC 通信使用 invoke 模式：比 send/receive 更适合 request-response 场景
- TypeScript 类型兼容：使用 `object | Record<string, unknown>` 来接受更灵活的参数类型
- Electron 的 process 对象在 renderer 进程中需要类型声明
- 所有 API 函数现在通过 apiClient.{get,post,put,delete,patch} 调用，保持与原有 axios API 相同的返回格式 {code, data, message}
---

## 2026-02-16 18:00 - US-004
- 实现 IPC 通道 `dialog:openDirectory`：在 main 进程中添加文件夹选择对话框处理器
- 更新 preload 脚本：`openDirectory` 方法已存在，通过 `invoke` 调用 main 进程
- 修改 connection-form.tsx：为 Local Path 字段添加 Browse 按钮（仅在 Electron 环境显示）
- 添加 FolderOpenIcon 图标组件用于 Browse 按钮
- 更新帮助文本：Electron 环境下显示"Select a local LanceDB database folder"
- 错误处理：通过 try-catch 处理对话框调用异常，用户取消时返回 null

**Learnings for future iterations:**
- Electron 的 dialog.showOpenDialog 需要在 main 进程中通过 ipcMain.handle 暴露
- 使用 `properties: ['openDirectory']` 限制只能选择文件夹（不能选择文件）
- 通过 BrowserWindow.getAllWindows()[0] 获取主窗口作为对话框的父窗口
- 在 UI 中使用 `isElectron()` 检测环境，条件显示 Electron 特有功能
- 对话框的权限错误（如无法访问文件夹）由 Electron 自动处理并显示系统错误对话框
---

## 2026-02-16 20:00 - US-005
- 安装 LanceDB Node.js SDK (vectordb) 到 apps/client
- 创建 lancedb.service.ts：实现所有数据库操作
  - 连接管理：connectToDatabase, closeConnection, testConnection
  - 数据库信息：getDatabaseInfo, getTables
  - 表操作：getTableSchema, getTableData, deleteTable, renameTable
  - 数据操作：deleteRows, deleteRowById
  - 查询：executeQuery（支持基本 SELECT * FROM）
  - 列操作：addColumn, dropColumn（抛出错误 - LanceDB 不支持）
- 创建 ipc-router.ts：将 HTTP API 映射到 LanceDB 服务
  - 注册 `api:request` IPC handler 处理所有 API 请求
  - 路由表覆盖所有 web app API 端点
  - 本地模式 mock 认证响应（免登录）
  - 新增 IPC 通道：db:connect, db:disconnect, db:test
- 更新 preload/index.ts：添加新的 IPC 通道到 VALID_INVOKE_CHANNELS
- 更新 main/index.ts：在 app.whenReady 中注册 IPC handlers
- 类型检查通过，lint 通过

**Learnings for future iterations:**
- LanceDB SDK 使用 `connect(uri)` 连接数据库，`table.search(vector)` 查询数据
- 非向量查询时使用 `table.search([])` 然后配合 `.filter()` 和 `.limit()`
- LanceDB 表结构基于 Apache Arrow，schema 包含字段名、类型、nullable 信息
- LanceDB 限制：不支持 ALTER TABLE（添加/删除列），不支持 RENAME TABLE
- IPC Router 模式让 web app 代码无需修改即可在 Electron 本地模式运行
- 使用 `void variable` 模式避免未使用参数警告（替代 underscore prefix）
---

## Notes

