# Ralph Progress Log
Started: 2026年 2月15日 星期日 23时33分46秒 CST
---

## Codebase Patterns
- The Electron IPC router uses a simple if/else routing pattern in `ipc-router.ts`
- Server controllers use `routing-controllers` decorators but IPC router uses manual pattern matching
- Error responses follow format: `{ code: number, data: T, msg: string }` (UPDATED: was `message?`, now matches server)
- Server uses `ResponseUtil.success/error` - IPC router uses `successResponse/errorResponse` helpers
- TypeDI is used for dependency injection in both server and client
- LanceDBService in Electron wraps `@mancedb/lancedb-core` services
- IPC router ErrorCode constants match server error-codes.ts (0=success, 1=system error, 2=params error, etc.)
- LanceDB table operations: `table.add(data)` for insert, `table.delete(where)` for delete (no direct update, use delete+insert)
- Common ID column names tried in order: 'id', '_id', 'row_id', 'pk'
- Vector search endpoint not implemented because web app doesn't use it (future enhancement if needed)

## 2026-02-17 10:30 - US-001
- **What was implemented:**
  - Analyzed all server controllers in `apps/server/src/controllers/`
  - Documented all 30+ API endpoints across 7 controller files
  - Compared against current IPC router implementation in `apps/client/src/main/ipc-router.ts`
  - Created comprehensive endpoint mapping document at `ralph/endpoint-mapping.md`

- **Files changed:**
  - Created: `ralph/endpoint-mapping.md` (new documentation)
  - Modified: `ralph/prd.json` (marked US-001 as complete)

- **Key findings:**
  - **Implemented (13 endpoints):** Database info/tables, Table schema/data/columns, Query, Auth (deprecated), Connection-auth
  - **Missing P0 (4 endpoints):** POST/GET/PUT/DELETE /api/v1/connections, GET /api/v1/connections/:id
  - **Missing P1 (3 endpoints):** Health check, User info get/update
  - **Partial (3 endpoints):** GET /connections (mock), /connections/:id/test (noop), /query/history (empty)

- **Learnings for future iterations:**
  - Connection management in Electron needs local persistence (electron-store or JSON file)
  - Auth endpoints should mirror server behavior (return disabled/anon user)
  - ~~Error handling pattern: IPC uses `errorResponse(msg, code)` vs Server's `ResponseUtil.error(code, msg)`~~ FIXED in US-002
  - The IPC router already has good pattern matching for dynamic routes using regex
  - LanceDBService already implements most table operations - just needs connection CRUD
---

## 2026-02-17 11:15 - US-002
- **What was implemented:**
  - Unified error handling and response format between IPC router and server
  - Changed APIResponse interface from `{ code, data, message? }` to `{ code, data, msg }` to match server
  - Added ErrorCode constants (SUCCESS, SYSTEM_ERROR, PARAMS_ERROR, NOT_FOUND, etc.) matching server
  - Added ErrorMessage mapping for consistent error messages
  - Created structured `logError()` function for error logging with timestamps, stack traces, and context
  - Updated `errorResponse()` parameter order from `(message, code)` to `(code, msg)` to match server
  - Updated `successResponse()` to always include `msg` field with default "操作成功"
  - Updated all error response calls to use proper ErrorCode constants
  - Added error logging to db:connect and db:connectS3 handlers

- **Files changed:**
  - Modified: `apps/client/src/main/ipc-router.ts`
  - Modified: `ralph/prd.json` (marked US-002 as complete)

- **Key changes in ipc-router.ts:**
  - Added ErrorCode and ErrorMessage constants (lines 34-58)
  - Added logError() helper function (lines 60-73)
  - Updated successResponse() to include msg field (lines 75-85)
  - Updated errorResponse() parameter order (lines 87-97)
  - Updated auth endpoints to use ErrorCode.FORBIDDEN (lines 237-251)
  - Updated 404 handler to use ErrorCode.NOT_FOUND (line 261)
  - Updated catch block to use logError() and ErrorCode.SYSTEM_ERROR (lines 263-268)
  - Added logError to db:connect handler (line 291)
  - Added logError to db:connectS3 handler (line 343)

- **Learnings for future iterations:**
  - IPC router now uses same response format as server: `{ code, data, msg }`
  - Error codes are defined locally in the file to avoid cross-package dependencies
  - Internal IPC handlers (db:connect, etc.) keep their own format - only API responses need to match
  - Always run both typecheck and lint before committing
---

## 2026-02-17 14:30 - US-003
- **What was implemented:**
  - Created `ConnectionService` for Electron main process with local file persistence
  - Implemented full connection CRUD operations in IPC router:
    - POST /api/v1/connections - Create connection with validation
    - GET /api/v1/connections - Get all connections
    - GET /api/v1/connections/:id - Get single connection by ID
    - PUT /api/v1/connections/:id - Update connection
    - DELETE /api/v1/connections/:id - Delete connection
    - POST /api/v1/connections/:id/test - Test connection (local and S3)
  - Connections stored in `userData/connections.json` (app's userData directory)
  - S3 credentials encrypted using CredentialService's safeStorage API
  - Added duplicate name validation for create and update operations

- **Files changed:**
  - Created: `apps/client/src/main/services/connection.service.ts` (311 lines)
  - Modified: `apps/client/src/main/ipc-router.ts` (added connection endpoints, imported ConnectionService)
  - Modified: `ralph/prd.json` (marked US-003 as complete)

- **Learnings for future iterations:**
  - ConnectionService uses TypeDI dependency injection with CredentialService and LanceDBService
  - Local connections store path only; S3 connections store config + encrypted credentials separately
  - The `hasCredentials` field tracks if S3 credentials exist (not if they're valid)
  - Connection IDs are generated using timestamp + random string format: `conn_${Date.now()}_${random}`
  - When deleting connections, associated S3 credentials are also cleaned up
  - TypeDI services in Electron main process are instantiated via `Container.get(ServiceName)`
---

## 2026-02-17 16:30 - US-005
- **What was implemented:**
  - Enhanced POST /api/v1/query endpoint with proper parameter validation and error handling
  - Improved GET /api/v1/query/history endpoint to parse limit parameter (returns empty array as query history is not persisted in Electron mode)
  - Implemented POST /api/v1/tables/:name/data endpoint for inserting data into tables
  - Implemented PUT /api/v1/tables/:name/data/:id endpoint for updating data by ID
  - Added insertData() method to LanceDBService using table.add() API
  - Added updateData() method to LanceDBService (delete old row + insert updated row pattern)
  - Added recordToObject() helper method for converting LanceDB records to plain objects

- **Files changed:**
  - Modified: `apps/client/src/main/ipc-router.ts` (added insert/update endpoints, enhanced query endpoint)
  - Modified: `apps/client/src/main/services/lancedb.service.ts` (added insertData, updateData, recordToObject methods)
  - Modified: `ralph/prd.json` (marked US-005 as complete)
  - Modified: `scripts/ralph/progress.txt` (added progress entry and updated patterns)

- **Key findings:**
  - POST /api/v1/query was already implemented but lacked proper validation and error handling
  - DELETE /api/v1/tables/:name/data/:id was already implemented in previous iterations
  - Vector search endpoint (POST /api/v1/search) is NOT used by the web app - no UI for vector search
  - LanceDB doesn't support direct updates; the pattern is: find row, delete it, insert updated version
  - Common ID column names are tried in order: 'id', '_id', 'row_id', 'pk'

- **Learnings for future iterations:**
  - LanceDB table.add(data) accepts an array of records for insertion
  - LanceDB table.delete(whereClause) deletes rows matching the filter
  - LanceDB table.query().where().limit().toArray() is used to find specific rows
  - The recordToObject pattern handles Float32Array, Float64Array, Uint8Array, Buffer, Date, and BigInt conversions
  - Always escape single quotes in string values when building WHERE clauses: `value.replace(/'/g, "\\'")`
  - Query history is not persisted in Electron mode (returns empty array) - could be enhanced with local storage if needed
---

## 2026-02-17 16:45 - US-006
- **What was implemented:**
  - Updated auth endpoints to match server behavior (authentication is disabled)
  - POST /api/v1/auth/register - Returns "User registration is disabled" error
  - POST /api/v1/auth/login - Returns "User login is disabled" error
  - POST /api/v1/auth/connections/login - Returns "Authentication is disabled" error
  - POST /api/v1/auth/connections/refresh - Returns "Token refresh is disabled" error
  - GET /api/v1/user/info - Returns anonymous user data (uid: 'anonymous', email: 'anonymous@mancedb.local', nickname: 'Anonymous')
  - PUT /api/v1/user/info - Returns success with anonymous user data (noop update)
  - Updated /api/v1/users/profile to return anonymous user (matching server)
  - Preserved /api/v1/auth/logout for backward compatibility (returns success)
  - Preserved /api/v1/auth/me for backward compatibility (returns error)

- **Files changed:**
  - Modified: `apps/client/src/main/ipc-router.ts` (updated auth endpoint handlers)
  - Modified: `ralph/prd.json` (marked US-006 as complete)
  - Modified: `scripts/ralph/progress.txt` (added progress entry)

- **Key findings:**
  - Server has deprecated authentication and returns mock responses
  - Web app calls auth endpoints but handles the disabled state gracefully
  - No JWT token handling needed in Electron mode (authentication is bypassed)
  - User endpoints return anonymous user to maintain API compatibility

- **Learnings for future iterations:**
  - Authentication endpoints should match server behavior exactly for web app compatibility
  - Error code PARAMS_ERROR (2) is used for disabled features (matching server)
  - Anonymous user pattern: { uid: 'anonymous', email: 'anonymous@mancedb.local', nickname: 'Anonymous' }
  - Connection-auth endpoints (/api/v1/connection-auth/verify) are separate from auth endpoints
---

## 2026-02-17 15:45 - US-004
- **What was implemented:**
  - Added `POST /api/v1/tables` endpoint to create new tables with column definitions
  - Added `GET /api/v1/tables/:name/count` endpoint to get table row count
  - Added `createTable()` method to LanceDBService for creating empty tables with schema
  - Added `getTableCount()` method to LanceDBService for getting row counts
  - Implemented validation for table names (alphanumeric + underscore, must start with letter/underscore)
  - Implemented validation for column definitions (name, type required)

- **Files changed:**
  - Modified: `apps/client/src/main/ipc-router.ts` (added POST /tables and GET /tables/:name/count handlers)
  - Modified: `apps/client/src/main/services/lancedb.service.ts` (added createTable and getTableCount methods)
  - Modified: `ralph/prd.json` (marked US-004 as complete)

- **Key findings:**
  - The PRD requirements mentioned `/api/v1/database/tables` paths, but the actual server and web app use `/api/v1/tables`
  - Most table management endpoints were already implemented in previous iterations
  - LanceDB's TableManager already has `createEmptyTable()` method which is perfect for the create table endpoint
  - Table row count is available via `table.countRows()` in LanceDB SDK

- **Learnings for future iterations:**
  - The TableManager in lancedb-core already provides most needed functionality
  - Table creation requires column definitions with name, type, and optional nullable flag
  - Supported column types: int64, int32, int, float64, float32, float, string, utf8, binary, bool, boolean
  - The IPC router pattern for table endpoints uses regex matching for dynamic routes
  - Always validate table/column names to match LanceDB naming conventions
---
